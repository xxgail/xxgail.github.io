{"title":"PHP生成验证码","slug":"PHP生成验证码","date":"2017-12-21T09:14:57.000Z","updated":"2017-12-21T09:28:16.310Z","comments":true,"path":"api/articles/PHP生成验证码.json","photos":[],"link":"","excerpt":"用原生PHP制作验证码<br>","covers":null,"content":"<p>用原生PHP制作验证码<br><a id=\"more\"></a><br>生成底图(GD库):<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$image = imagecreatetruecolor(<span class=\"number\">100</span>, <span class=\"number\">30</span>);<span class=\"comment\">//创建一个宽100高30的（默认）黑色图片</span></span><br><span class=\"line\">$bgcolor = imagecolorallocate($image,<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">255</span>);<span class=\"comment\">//为资源创建颜色</span></span><br><span class=\"line\">imagefill($image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $bgcolor);<span class=\"comment\">//将创造的颜色铺满图片    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//在所有输出面前加一个格式</span></span><br><span class=\"line\">header(<span class=\"string\">'content-type:image/png'</span>);</span><br><span class=\"line\">imagepng($image);</span><br><span class=\"line\"><span class=\"comment\">// end 将资源销毁</span></span><br><span class=\"line\">imagedestroy($image);</span><br><span class=\"line\">$image = imagecreatetruecolor(<span class=\"number\">100</span>, <span class=\"number\">30</span>);<span class=\"comment\">//创建一个宽100高30的（默认）黑色图片</span></span><br><span class=\"line\">$bgcolor = imagecolorallocate($image,<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">255</span>);<span class=\"comment\">//为资源创建颜色</span></span><br><span class=\"line\">imagefill($image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $bgcolor);<span class=\"comment\">//将创造的颜色铺满图片    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//在所有输出面前加一个格式</span></span><br><span class=\"line\">header(<span class=\"string\">'content-type:image/png'</span>);</span><br><span class=\"line\">imagepng($image);</span><br><span class=\"line\"><span class=\"comment\">// end 将资源销毁</span></span><br><span class=\"line\">imagedestroy($image);</span><br></pre></td></tr></table></figure></p>\n<p>加入干扰元素:<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//加入干扰点</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">200</span>;$i++)&#123;</span><br><span class=\"line\">\t\t$pointcolor = imagecolorallocate($image,rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>),rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>),rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>));<span class=\"comment\">//定义点的颜色</span></span><br><span class=\"line\">\t\timagesetpixel($image,rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>), $pointcolor); <span class=\"comment\">//画一个单一像素。资源图片，坐标，点</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//加入干扰线</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>; $i &lt; <span class=\"number\">3</span>; $i++) &#123; </span><br><span class=\"line\">\t\t$linecolor = imagecolorallocate($image, rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>),rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>),rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>));</span><br><span class=\"line\">\t\timageline($image,rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>),$linecolor);<span class=\"comment\">//画一条线段。有起始和终止坐标</span></span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>生成验证内容(字母数字混合):<br><figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   $captch_code=<span class=\"string\">''</span>;</span><br><span class=\"line\"><span class=\"comment\">//为验证码生成字母数字的混合</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>; $i &lt; <span class=\"number\">4</span>; $i++) &#123; </span><br><span class=\"line\">\t$fontsize = <span class=\"number\">6</span>;                                                                                                         </span><br><span class=\"line\">\t$fontcolor = imagecolorallocate($image,<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>),<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>),<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>));</span><br><span class=\"line\">   </span><br><span class=\"line\">\t$data = <span class=\"string\">'abcdefghijkmnopqrstuvwxy3456789'</span>;</span><br><span class=\"line\">\t$fontcontent = substr($data,<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,strlen($data)),<span class=\"number\">1</span>);</span><br><span class=\"line\">\t$captch_code .=$fontcontent;</span><br><span class=\"line\">   </span><br><span class=\"line\">\t$x = ($i*<span class=\"number\">100</span>/<span class=\"number\">4</span>)+<span class=\"keyword\">rand</span>(<span class=\"number\">5</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">\t$y = <span class=\"keyword\">rand</span>(<span class=\"number\">5</span>,<span class=\"number\">10</span>);</span><br><span class=\"line\">   </span><br><span class=\"line\">\timagestring($image, $fontsize, $x, $y, $fontcontent, $fontcolor);</span><br><span class=\"line\">   \t&#125;</span><br><span class=\"line\">   \t$_SESSION[<span class=\"string\">'authcode'</span>] = $captch_code;<span class=\"comment\">//保存在表单信息中</span></span><br></pre></td></tr></table></figure></p>\n<p>生成验证内容(图片验证):</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$table = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">\t\t<span class=\"string\">'pic0'</span>=&gt;<span class=\"string\">'狗'</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">'pic1'</span>=&gt;<span class=\"string\">'猫'</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">'pic2'</span>=&gt;<span class=\"string\">'鸡'</span>,</span><br><span class=\"line\">\t\t<span class=\"string\">'pic3'</span>=&gt;<span class=\"string\">'兔'</span>,</span><br><span class=\"line\">\t\t);<span class=\"comment\">//创建一个数组将图库中的图片与验证码信息对应起来</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t$index = rand(<span class=\"number\">0</span>,<span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t$value = $table[<span class=\"string\">'pic'</span>.$index];</span><br><span class=\"line\">\t$_SESSION[<span class=\"string\">'authcode'</span>] = $value;<span class=\"comment\">//存到session中</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t$filename = dirname(<span class=\"keyword\">__FILE__</span>).<span class=\"string\">'\\\\pic'</span>.$index.<span class=\"string\">'.jpg'</span>;<span class=\"comment\">//物料，找到文件</span></span><br><span class=\"line\">\t$contents = file_get_contents($filename);<span class=\"comment\">//取得内容</span></span><br><span class=\"line\"></span><br><span class=\"line\">\theader(<span class=\"string\">'content-type:image/jpg'</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> $contents;</span><br></pre></td></tr></table></figure>\n<p>生成验证内容(汉字):</p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   <span class=\"comment\">//GBK编码时，需要将中文通过 iconv() 转化为utf-8</span></span><br><span class=\"line\">   $fontface = <span class=\"string\">'simkai.ttf'</span>;<span class=\"comment\">//需要一个可以显示中文的字体</span></span><br><span class=\"line\">$str = <span class=\"string\">\"小盖最帅\"</span>;<span class=\"comment\">//汉字库</span></span><br><span class=\"line\">$strdb = str_split($str,<span class=\"number\">3</span>);<span class=\"comment\">//在utf-8中一个汉字占3个字符</span></span><br><span class=\"line\">$captch_code=<span class=\"string\">''</span>;</span><br><span class=\"line\"><span class=\"comment\">//为验证码生成汉字</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>; $i &lt; <span class=\"number\">4</span>; $i++) &#123; </span><br><span class=\"line\">       $fontcolor = imagecolorallocate($image,<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>),<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>),<span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,<span class=\"number\">120</span>));</span><br><span class=\"line\">   </span><br><span class=\"line\">    $index = <span class=\"keyword\">rand</span>(<span class=\"number\">0</span>,count($strdb));</span><br><span class=\"line\">\t$cn = $strdb[$index];</span><br><span class=\"line\">\t$captch_code.=$cn;</span><br><span class=\"line\">   </span><br><span class=\"line\">\timagettftext($image, mt_rand(<span class=\"number\">20</span>,<span class=\"number\">24</span>), mt_rand(<span class=\"number\">-60</span>,<span class=\"number\">60</span>), (<span class=\"number\">40</span>*$i+<span class=\"number\">20</span>), mt_rand(<span class=\"number\">30</span>,<span class=\"number\">35</span>), $fontcolor, $fontface,$cn);</span><br><span class=\"line\">   \t&#125;</span><br><span class=\"line\">   \t$_SESSION[<span class=\"string\">'authcode'</span>] = $captch_code;</span><br></pre></td></tr></table></figure>\n<p>使用session来检验:<br><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (isset(<span class=\"variable\">$_REQUEST</span>[<span class=\"string\">'authcode'</span>])) &#123;</span><br><span class=\"line\">\tsession_start();<span class=\"regexp\">//</span>在验证码的代码开头必须加上这句话</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (strtolower(<span class=\"variable\">$_REQUEST</span>[<span class=\"string\">'authcode'</span>]) == <span class=\"variable\">$_SESSION</span>[<span class=\"string\">'authcode'</span>]) &#123;</span><br><span class=\"line\">\t\theader(<span class=\"string\">'Content-type: text/html; charset=UTF8'</span>); </span><br><span class=\"line\">\t\techo <span class=\"string\">'&lt;font color=\"#0000CC\"&gt;输入正确&lt;/font&gt;'</span>;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t\theader(<span class=\"string\">'Content-type: text/html; charset=UTF8'</span>); </span><br><span class=\"line\">\t\techo <span class=\"string\">'&lt;font color=\"#CC0000\"&gt;&lt;b&gt;输入错误&lt;/b&gt;&lt;/font&gt;'</span>;</span><br><span class=\"line\">\t&#125;<span class=\"regexp\">//</span>相同返回正确，否则返回错误</span><br><span class=\"line\">\t<span class=\"keyword\">exit</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>利用Ajax来小部分刷新:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">\"post\"</span> <span class=\"attr\">action</span>=<span class=\"string\">\"./form.php\"</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>验证码图片：</span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">id</span>=<span class=\"string\">\"captcha_img\"</span> <span class=\"attr\">border</span>=<span class=\"string\">\"1\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"./captcha.php?r=&lt;?php echo rand();?&gt;\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"200\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"60\"</span> &gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"javascript:void(0)\"</span> <span class=\"attr\">onClick</span>=<span class=\"string\">\"document.getElementById('captcha_img').src='./captcha.php?r='+Math.random()\"</span>&gt;</span>换一个？<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">&lt;!--Ajax--&gt;</span></span><br><span class=\"line\">\t\t<span class=\"comment\">&lt;!--此处改变验证内容只需改变src即可--&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>请输入图片中的内容：<span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"authcode\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"submit\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"提交\"</span> <span class=\"attr\">style</span>=<span class=\"string\">\"padding: 6px 20px;\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br></pre></td></tr></table></figure>","categories":[{"name":"编程","slug":"编程","count":12,"path":"api/categories/编程.json"}],"tags":[{"name":"php","slug":"php","count":7,"path":"api/tags/php.json"}]}