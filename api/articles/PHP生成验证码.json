{"title":"PHP生成验证码","slug":"PHP生成验证码","date":"2017-12-21T09:14:57.000Z","updated":"2017-12-21T09:28:16.310Z","comments":true,"path":"api/articles/PHP生成验证码.json","photos":[],"link":"","excerpt":"用原生PHP制作验证码<br>","covers":null,"content":"<p>用原生PHP制作验证码<br><a id=\"more\"></a><br>生成底图(GD库):<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$image = imagecreatetruecolor(<span class=\"number\">100</span>, <span class=\"number\">30</span>);<span class=\"comment\">//创建一个宽100高30的（默认）黑色图片</span></span><br><span class=\"line\">$bgcolor = imagecolorallocate($image,<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">255</span>);<span class=\"comment\">//为资源创建颜色</span></span><br><span class=\"line\">imagefill($image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $bgcolor);<span class=\"comment\">//将创造的颜色铺满图片    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//在所有输出面前加一个格式</span></span><br><span class=\"line\">header(<span class=\"string\">'content-type:image/png'</span>);</span><br><span class=\"line\">imagepng($image);</span><br><span class=\"line\"><span class=\"comment\">// end 将资源销毁</span></span><br><span class=\"line\">imagedestroy($image);</span><br><span class=\"line\">$image = imagecreatetruecolor(<span class=\"number\">100</span>, <span class=\"number\">30</span>);<span class=\"comment\">//创建一个宽100高30的（默认）黑色图片</span></span><br><span class=\"line\">$bgcolor = imagecolorallocate($image,<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">255</span>);<span class=\"comment\">//为资源创建颜色</span></span><br><span class=\"line\">imagefill($image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $bgcolor);<span class=\"comment\">//将创造的颜色铺满图片    </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//在所有输出面前加一个格式</span></span><br><span class=\"line\">header(<span class=\"string\">'content-type:image/png'</span>);</span><br><span class=\"line\">imagepng($image);</span><br><span class=\"line\"><span class=\"comment\">// end 将资源销毁</span></span><br><span class=\"line\">imagedestroy($image);</span><br></pre></td></tr></table></figure></p>\n<p>加入干扰元素:<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//加入干扰点</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">200</span>;$i++)&#123;</span><br><span class=\"line\">\t\t$pointcolor = imagecolorallocate($image,rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>),rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>),rand(<span class=\"number\">50</span>,<span class=\"number\">200</span>));<span class=\"comment\">//定义点的颜色</span></span><br><span class=\"line\">\t\timagesetpixel($image,rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>), $pointcolor); <span class=\"comment\">//画一个单一像素。资源图片，坐标，点</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//加入干扰线</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>; $i &lt; <span class=\"number\">3</span>; $i++) &#123; </span><br><span class=\"line\">\t\t$linecolor = imagecolorallocate($image, rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>),rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>),rand(<span class=\"number\">80</span>,<span class=\"number\">220</span>));</span><br><span class=\"line\">\t\timageline($image,rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">99</span>),rand(<span class=\"number\">1</span>,<span class=\"number\">29</span>),$linecolor);<span class=\"comment\">//画一条线段。有起始和终止坐标</span></span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure></p>\n<p>生成验证内容(字母数字混合):<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   $captch_code=&apos;&apos;;</span><br><span class=\"line\">//为验证码生成字母数字的混合</span><br><span class=\"line\">for ($i=0; $i &lt; 4; $i++) &#123; </span><br><span class=\"line\">\t$fontsize = 6;                                                                                                         </span><br><span class=\"line\">\t$fontcolor = imagecolorallocate($image,rand(0,120),rand(0,120),rand(0,120));</span><br><span class=\"line\">   </span><br><span class=\"line\">\t$data = &apos;abcdefghijkmnopqrstuvwxy3456789&apos;;</span><br><span class=\"line\">\t$fontcontent = substr($data,rand(0,strlen($data)),1);</span><br><span class=\"line\">\t$captch_code .=$fontcontent;</span><br><span class=\"line\">   </span><br><span class=\"line\">\t$x = ($i*100/4)+rand(5,10);</span><br><span class=\"line\">\t$y = rand(5,10);</span><br><span class=\"line\">   </span><br><span class=\"line\">\timagestring($image, $fontsize, $x, $y, $fontcontent, $fontcolor);</span><br><span class=\"line\">   \t&#125;</span><br><span class=\"line\">   \t$_SESSION[&apos;authcode&apos;] = $captch_code;//保存在表单信息中</span><br></pre></td></tr></table></figure></p>\n<p>生成验证内容(图片验证):</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$table = array(</span><br><span class=\"line\">\t\t&apos;pic0&apos;=&gt;&apos;狗&apos;,</span><br><span class=\"line\">\t\t&apos;pic1&apos;=&gt;&apos;猫&apos;,</span><br><span class=\"line\">\t\t&apos;pic2&apos;=&gt;&apos;鸡&apos;,</span><br><span class=\"line\">\t\t&apos;pic3&apos;=&gt;&apos;兔&apos;,</span><br><span class=\"line\">\t\t);//创建一个数组将图库中的图片与验证码信息对应起来</span><br><span class=\"line\"></span><br><span class=\"line\">\t$index = rand(0,3);</span><br><span class=\"line\"></span><br><span class=\"line\">\t$value = $table[&apos;pic&apos;.$index];</span><br><span class=\"line\">\t$_SESSION[&apos;authcode&apos;] = $value;//存到session中</span><br><span class=\"line\"></span><br><span class=\"line\">\t$filename = dirname(__FILE__).&apos;\\\\pic&apos;.$index.&apos;.jpg&apos;;//物料，找到文件</span><br><span class=\"line\">\t$contents = file_get_contents($filename);//取得内容</span><br><span class=\"line\"></span><br><span class=\"line\">\theader(&apos;content-type:image/jpg&apos;);</span><br><span class=\"line\">\techo $contents;</span><br></pre></td></tr></table></figure>\n<p>生成验证内容(汉字):</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   //GBK编码时，需要将中文通过 iconv() 转化为utf-8</span><br><span class=\"line\">   $fontface = &apos;simkai.ttf&apos;;//需要一个可以显示中文的字体</span><br><span class=\"line\">$str = &quot;小盖最帅&quot;;//汉字库</span><br><span class=\"line\">$strdb = str_split($str,3);//在utf-8中一个汉字占3个字符</span><br><span class=\"line\">$captch_code=&apos;&apos;;</span><br><span class=\"line\">//为验证码生成汉字</span><br><span class=\"line\">for ($i=0; $i &lt; 4; $i++) &#123; </span><br><span class=\"line\">       $fontcolor = imagecolorallocate($image,rand(0,120),rand(0,120),rand(0,120));</span><br><span class=\"line\">   </span><br><span class=\"line\">    $index = rand(0,count($strdb));</span><br><span class=\"line\">\t$cn = $strdb[$index];</span><br><span class=\"line\">\t$captch_code.=$cn;</span><br><span class=\"line\">   </span><br><span class=\"line\">\timagettftext($image, mt_rand(20,24), mt_rand(-60,60), (40*$i+20), mt_rand(30,35), $fontcolor, $fontface,$cn);</span><br><span class=\"line\">   \t&#125;</span><br><span class=\"line\">   \t$_SESSION[&apos;authcode&apos;] = $captch_code;</span><br></pre></td></tr></table></figure>\n<p>使用session来检验:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (isset($_REQUEST[&apos;authcode&apos;])) &#123;</span><br><span class=\"line\">\tsession_start();//在验证码的代码开头必须加上这句话</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (strtolower($_REQUEST[&apos;authcode&apos;]) == $_SESSION[&apos;authcode&apos;]) &#123;</span><br><span class=\"line\">\t\theader(&apos;Content-type: text/html; charset=UTF8&apos;); </span><br><span class=\"line\">\t\techo &apos;&lt;font color=&quot;#0000CC&quot;&gt;输入正确&lt;/font&gt;&apos;;</span><br><span class=\"line\">\t&#125;else&#123;</span><br><span class=\"line\">\t\theader(&apos;Content-type: text/html; charset=UTF8&apos;); </span><br><span class=\"line\">\t\techo &apos;&lt;font color=&quot;#CC0000&quot;&gt;&lt;b&gt;输入错误&lt;/b&gt;&lt;/font&gt;&apos;;</span><br><span class=\"line\">\t&#125;//相同返回正确，否则返回错误</span><br><span class=\"line\">\texit();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>利用Ajax来小部分刷新:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form method=&quot;post&quot; action=&quot;./form.php&quot;&gt;</span><br><span class=\"line\">\t\t&lt;p&gt;验证码图片：</span><br><span class=\"line\">\t\t&lt;img id=&quot;captcha_img&quot; border=&quot;1&quot; src=&quot;./captcha.php?r=&lt;?php echo rand();?&gt;&quot; width=&quot;200&quot; height=&quot;60&quot; &gt;</span><br><span class=\"line\">\t\t&lt;a href=&quot;javascript:void(0)&quot; onClick=&quot;document.getElementById(&apos;captcha_img&apos;).src=&apos;./captcha.php?r=&apos;+Math.random()&quot;&gt;换一个？&lt;/a&gt;</span><br><span class=\"line\">\t\t&lt;!--Ajax--&gt;</span><br><span class=\"line\">\t\t&lt;!--此处改变验证内容只需改变src即可--&gt;</span><br><span class=\"line\">\t\t&lt;/p&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t&lt;p&gt;请输入图片中的内容：&lt;input type=&quot;text&quot; name=&quot;authcode&quot; value=&quot;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">\t\t&lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;提交&quot; style=&quot;padding: 6px 20px;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">\t&lt;/form&gt;</span><br></pre></td></tr></table></figure>","categories":[{"name":"编程","slug":"编程","count":11,"path":"api/categories/编程.json"}],"tags":[{"name":"php","slug":"php","count":6,"path":"api/tags/php.json"}]}